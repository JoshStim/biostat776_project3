---
title: 'Statistical Computing: Project 3'
author: "Josh Stim"
date: "2023-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Exploring album sales and sentiment of lyrics from Beyoncé and Taylor Swift {.tabset .tabset-fade}

## Part 0. Setting up

Load relevant R packages
```{r}
library(here)
library(tidyverse)
library(tidytext)
library(wordcloud)
```

Get data from tidytuesday github and store locally. Load the datasets and make copy for modification.
```{r}
if (!file.exists(here("data", "b_lyrics.RDS"))) {
    b_lyrics <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-29/beyonce_lyrics.csv")
    ts_lyrics <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-29/taylor_swift_lyrics.csv")
    sales <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-29/sales.csv")

    # save the files to RDS objects
    saveRDS(b_lyrics, file = here("data", "b_lyrics.RDS"))
    saveRDS(ts_lyrics, file = here("data", "ts_lyrics.RDS"))
    saveRDS(sales, file = here("data", "sales.RDS"))
}

b_lyrics.raw <- readRDS(here("data", "b_lyrics.RDS"))
ts_lyrics.raw <- readRDS(here("data", "ts_lyrics.RDS"))
sales.raw <- readRDS(here("data", "sales.RDS"))

sales.mod <- sales.raw
```

## Part 1. Explore album sales

In this section, the goal is to explore the sales of studio albums from Beyoncé and Taylor Swift.

#### Notes

-   In each of the subsections below that ask you to create a plot, you must create a title, subtitle, x-axis label, and y-axis label with units where applicable. For example, if your axis says “sales” as an axis label, change it to “sales (in millions)”.

### a. Data wrangling

1.    Use lubridate to create a column called released that is a Date class. However, to be able to do this, you first need to use stringr to search for pattern that matches things like this “(US)[51]” in a string like this “September 1, 2006 (US)[51]” and removes them. (Note: to get full credit, you must create the regular expression).

2.    Use forcats to create a factor called country (Note: you may need to collapse some factor levels).

3.    Transform the sales into a unit that is album sales in millions of dollars.

4.    Keep only album sales from the UK, the US or the World.

5.    Auto print your final wrangled tibble data frame.

```{r}
################################################################################
# 1. Convert sales$released to variable of type Date
################################################################################
sales.mod$released <- 
  str_replace(sales.raw$released, "( |)\\(U(K|S)\\)\\[[0-9]{2}\\]$", "") %>%
  mdy()

################################################################################
# 2. Make sales$country into a factor variable
################################################################################
sales.mod$country <- 
  factor(sales.raw$country) %>%
  fct_collapse(
    WW = c("WW", "World"),
    FRA = c("FRA","FR")
  )

################################################################################
# 3 & 4. Transform sales$sales to "millions of dollars". Only look at album 
# sales from US, UK, and World
################################################################################
sales.mod$sales <- sales.raw$sales / (10 ** 6)
sales.mod.subset <- filter(sales.mod, country %in% c("US", "UK", "WW"))

################################################################################
# 5. Auto print final wrangled tibble data frame.
################################################################################
sales.mod.subset
```

### b. More data wrangling

1.    Keep only album sales from the US.

2.    Create a new column called years_since_release corresponding to the number of years since the release of each album from Beyoncé and Taylor Swift. This should be a whole number and you should round down to “14” if you get a non-whole number like “14.12” years. (Hint: you may find the interval() function from lubridate helpful here, but this not the only way to do this.)

3.    Calculate the most recent, oldest, and the median years since albums were released for both Beyoncé and Taylor Swift.

```{r}
sales.mod.subset %>%
  filter(country == "US") %>%
  mutate(years_since_release = year(as.period(interval(released, today())))) %>%
  group_by(artist) %>%
  summarize(newest.years_since_release = min(years_since_release),
            oldest.years_since_release = max(years_since_release),
            median.years_since_release = median(years_since_release))

```

### c. Album sales share by country: Percent stacked barchart

Using the wrangled data from Part 1A:

1.    Calculate the total album sales for each artist and for each country (only sales from the UK, US, and World).

2.    Using the total album sales, create a percent stacked barchart using ggplot2 of the percentage of sales of studio albums (in millions) along the y-axis for the two artists along the x-axis colored by the country.

```{r}
sales.mod.subset %>%
  group_by(artist, country) %>%
  summarize(total.sales = sum(sales)) %>%
  ggplot(aes(x = artist, y = total.sales, fill = country)) +
  geom_bar(position = "fill", stat = "identity") +
  labs(x = "Artist",
       y = "Proportion of album sales") +
  theme_bw()
```

### d. Album sales by album: Horizontal bar chart

Using the wrangled data from Part 1A, use ggplot2 to create a bar plot for the sales of studio albums (in millions) along the x-axis for each of the album titles along the y-axis.

#### Note.

-   You only need to consider the global World sales (you can ignore US and UK sales for this part).

-   The title of the album must be clearly readable along the y-axis.

-   Each bar should be colored by which artist made that album.

-   The bars should be ordered from albums with the most sales (top) to the least sales (bottom) (Note: you must use functions from forcats for this step).

```{r}
sales.mod.subset %>%
  filter(country == "WW") %>%
  arrange(sales) %>%
  ggplot(aes(x = fct_inorder(title), y = sales, fill = artist)) +
  geom_bar(stat = "identity") +
  labs(x = "Album Title",
       y = "Sales (in Million USD)") +
  coord_flip() + 
  theme_bw()
```

### e. Visualizing album sales across time: Scatter Plot

Using the wrangled data from Part 1A, use ggplot2 to create a scatter plot of sales of studio albums (in millions) along the y-axis by the released date for each album along the x-axis.

#### Note:

-   The points should be colored by the artist.

-   There should be three scatter plots (one for UK, US and world sales) faceted by rows.

```{r}
sales.mod.subset %>%
  ggplot(aes(x = released, y = sales, color = artist)) +
  geom_hline(yintercept = 0) +
  geom_segment(aes(x = released, y = 0, xend = released, yend = sales)) + 
  geom_point() +
  facet_wrap(~country, nrow = 3) +
  labs(title = "Beyoncé & Taylor Swift: Album sales across time and country",
       x = "Release date",
       y = "Sales (in Million USD)") +
  theme_bw()
```

## Part 2. Exploring Sentiment of Lyrics

### a. Using `ts_lyrics`, create a new column called `line` with one line containing the character string for each line of Taylor Swift’s songs. 
-   How many lines in Taylor Swift’s lyrics contain the word “hello”? For full credit, show all the rows in `ts_lyrics` that have “hello” in the line column and report how many rows there are in total.

-   How many lines in Taylor Swift’s lyrics contain the word “goodbye”? For full credit, show all the rows in `ts_lyrics` that have “goodbye” in the line column and report how many rows there are in total.

```{r}
################################################################################
# Flatten ts_lyrics by separating Lyrics into lines
################################################################################
ts_lyrics.mod.lines <- ts_lyrics.raw %>%
  unnest_tokens(
    output = line,
    input = Lyrics,
    token = "lines"
  )

################################################################################
# Report lines that contain the word "hello"
################################################################################
ts_lyrics.mod.lines %>%
  filter(str_detect(line, "hello"))

################################################################################
# Report lines that contain the word "goodbye"
################################################################################
ts_lyrics.mod.lines %>%
  filter(str_detect(line, "goodbye"))
```

### b. Repeat the same analysis for b_lyrics as described in Part 2A.

```{r}
b_lyrics.raw %>%
    filter(str_detect(line, "hello"))

b_lyrics.raw %>%
  filter(str_detect(line, "goodbye"))
```

### c. 

Using the `b_lyrics` dataset,

1.    Tokenize each lyrical line by words.

2.    Remove the “stopwords”.

3.    Calculate the total number for each word in the lyrics.

4.    Using the “bing” sentiment lexicon, add a column to the summarized data frame adding the “bing” sentiment lexicon.

5.    Sort the rows from most frequent to least frequent words.

6.    Only keep the top 25 most frequent words.

7.    Auto print the wrangled tibble data frame.

8.    Use `ggplot2` to create a bar plot with the top words on the y-axis and the frequency of each word on the x-axis. Color each bar by the sentiment of each word from the “bing” sentiment lexicon. Bars should be ordered from most frequent on the top to least frequent on the bottom of the plot.

9.    Create a word cloud of the top 25 most frequent words.

```{r}
b_lyrics.mod.words <- b_lyrics.raw %>%
    unnest_tokens(
    output = word,
    input = line,
    token = "words"
  ) %>%
  anti_join(stop_words)

b_lyrics.summary <- b_lyrics.mod.words %>%
  count(word, sort = TRUE) %>%
  inner_join(get_sentiments("bing")) %>%
  head(n = 25L)

b_lyrics.summary
  
b_lyrics.summary %>%
  ggplot(aes(x = fct_rev(fct_inorder(word)), y = n, fill = sentiment)) +
  geom_bar(stat = "identity") +
  labs(title = "Beyonce Sentiment Analysis: Top 25 Words",
       x = "Word",
       y = "Count") +
  coord_flip() +
  theme_bw()

b_lyrics.summary %>%
  with(wordcloud(word, n))
```

### d. Repeat the same analysis as above in Part 2C, but for `ts_lyrics`.

```{r}
ts_lyrics.mod.words <- ts_lyrics.mod.lines %>%
    unnest_tokens(
    output = word,
    input = line,
    token = "words"
  ) %>%
  anti_join(stop_words)

ts_lyrics.summary <- ts_lyrics.mod.words %>%
  count(word, sort = TRUE) %>%
  inner_join(get_sentiments("bing")) %>%
  head(n = 25L)

ts_lyrics.summary
  
ts_lyrics.summary %>%
  ggplot(aes(x = fct_rev(fct_inorder(word)), y = n, fill = sentiment)) +
  geom_bar(stat = "identity") +
  labs(title = "Taylor Swift Sentiment Analysis: Top 25 Words",
       x = "Word",
       y = "Count") +
  coord_flip() +
  theme_bw()

ts_lyrics.summary %>%
  with(wordcloud(word, n))
```
